---
title: "S1global_nback_prospective_analysis"
output: html_document
---


#packages
```{r, include= F}
library(tidyverse)
library(rmarkdown)
library(ggpubr)
library(viridis)
library(cowplot)
library(RColorBrewer)
library(R.utils)

library(lme4)
library(lmtest)
library(emmeans)
library(stargazer)
library(performance)

# library(factoextra)
# library(moments)
# library(ordinal)
```

#functions
```{r, include= F}
## Standard Error of the Mean (SEM)
 #Don't forget 10 ms bruit gorilla
sem <- function(x, na.rm=FALSE) {
     if(na.rm==TRUE) x <- na.omit(x)
     sd(x)/sqrt(length(x)) 
}

##coefficent of variation
cv <- function(x){sd(x)/mean(x)}

#Z-score
z_score <- function(x){(x - mean(x)) / sd(x)}
```

#palettes
```{r, include= F}
#Palettes of colours
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442",
               "#0072B2", "#D55E00", "#CC79A7")

cbPalette2 <- c("#0072B2", "#CC79A7")

cbPalette2_v2 <- c("#66c2a4", "#fc8d59")

cbPalette4 <- c( "#56B4E9", "#009E73", "#E69F00", "#D55E00", "#CC79A7")

cbPalette5 <- c( "#CC79A7", "#009E73")
```

#Formatting duration estimations 
```{r}

#Extract processed data for session 1
file <- "/home/user/Desktop/Documents/TimeSocialDistancing/nback_TSD/S1global_nback.csv"

Nback = read.csv2(file, sep = ",")


# Each row is a participant response
#Defining if the letter is a target letter and if an answer is a hit, a correct reject, a miss or a false alarm. 
Nback_all <- Nback %>%           #572,646 observations
   filter(!is.na(translated)) %>%
         mutate(PID = as.factor(PID),
         timing_error = as.numeric(as.character(translated)) - parse_number(as.character(duration)))
        


# Each row is a different trial
Nback_blocks <- Nback_all %>%    #3785 trials
  group_by(country) %>%
  group_by(PID, .add = T) %>%
  group_by(Run, .add = T) %>%
  group_by(nback, .add =T) %>%
  group_by(ILI, duration, block_nb, .add = T) %>%
  summarise(condition = first(condition),
            retro.pro = first(retro.pro),
            likert = first(likert),
            translated = first(translated),
            timing_error = first(timing_error),
            ntarget = first(ntarget),
            notarget = first(notarget),
            mRT = mean(as.numeric(as.character(Reaction.Time))),
            hit = sum(response_arrow == "Left" & Correct == T),
            miss  = sum(response_arrow == "Down" & Correct == F),
            fa = sum(response_arrow == "Left" & Correct == F),
            cr = sum(response_arrow == "Down" & Correct == T),
            HR = sum(response_arrow == "Left" & Correct == T)/ntarget,
            FA = sum(response_arrow == "Left" & Correct == F)/notarget,
            CR = sum(response_arrow == "Down" & Correct == T)/notarget,
            MR = sum(response_arrow == "Down" & Correct == F)/ntarget,
            handedness = first(handedness),
            age = first(age)) %>%
  ungroup() 

Nback_blocks <- Nback_blocks %>%
  filter(HR < 1.2 & MR < 1.5 & CR < 1.5) %>%
  mutate(HR = ifelse(HR > 1, 1, HR),
         FA = ifelse(FA > 1, 1, FA),
         CR = ifelse(CR > 1, 1, CR),
         HR = ifelse(HR == 0, 0.01, HR),
  HR = ifelse(HR == 1, 0.99, HR),
  FA = ifelse(FA == 0, 0.01, FA),
  FA = ifelse(FA == 1, 0.99, FA),
  dprime = qnorm(HR) - qnorm(FA),
  cdur = 4,
  cdur = ifelse(duration == "45s" & nback == "3back", 3, cdur),
  cdur = ifelse(duration == "90s" & nback == "1back", 2, cdur),
  cdur = ifelse(duration == "45s" & nback == "1back", 1, cdur))
 

veryquickly = c("muy rápido", "Très rapidement","Πολύ Γρήγορα","Very Fast","Molto veloce","Çok hızlı","とても速かった")
quickly = c("rápido", "Rapidement","Γρήγορα","Fast","Veloce","Hızlı","速かった")
normally = c("Normalement", "Κανονικά", "Neutral", "Neutrale", "普通", "Nötr", "normal")
slowly = c("lento","Lentement","Αργά","Slow","Very Slow","Lentamente","Yavaş", "遅かった") 
veryslowly = c("Muy lento", "Très lentement","Πολύ Αργά","Molto lentamente","Çok yavaş","とても遅かった")

Nback_blocks <- Nback_blocks %>%
  mutate(likert = ifelse(likert %in% veryquickly, "Very Quickly", as.character(likert)),
         likert = ifelse(likert %in% quickly, "Quickly", as.character(likert)),
         likert = ifelse(likert %in% normally, "Normally", as.character(likert)),
         likert = ifelse(likert %in% slowly, "Slowly", as.character(likert)),
         likert = ifelse(likert %in% veryslowly, "Very Slowly", as.character(likert))) %>%
  mutate(likert = fct_relevel(likert, "Very Slowly", "Slowly",  "Normally", "Quickly", "Very Quickly"),
  likert_n = as.factor(recode(likert, "Very Slowly" = -2, "Slowly" = -1, "Normally" = 0, "Quickly" = 1, "Very Quickly" = 2))) 

Nback_blocks %>%
  group_by(likert_n) %>%
  summarise(n = n())



#10.5 % of the participants produced more answers than the number of letters displayed


#Do we discard left-handed participants
Nback_blocks %>%
  group_by(retro.pro, handedness) %>%
  summarise(n = n())
  

```






#Remove retrospective tasks (first trial of the first run for each participant)
```{r}
#What is the first design condition encountered by the subject ?
Nback_blocks %>%
  filter(retro.pro == "retrospective") %>%
  count(condition)

Nback_blocks %>%
  filter(retro.pro == "retrospective")
#1089 retrospective trials (1089 participants)


#keep only prospective trials
Nback_blocks <- Nback_blocks %>%
  filter(retro.pro == "prospective")

#15141 --> 14117 trials

#~6500 31-back tasks and ~7500 3-back tasks
```




```{r}

#HR DISTRIBUTION


jpeg("DistributionHRS1pro.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(HR)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(1000 * 0.02)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "HR", title ="Hit Rate (HR) distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 dev.off()

#FA DISTRIBUTION

jpeg("DistributionFAS1pro.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(FA)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(500 * 0.02)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "FA", title ="False alarm rate (FA) distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 dev.off()


#CR DISTRIBUTION


# jpeg("DistributionCRS1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(CR)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") +
      # geom_density(aes(y = ..density..*(00 * 0.02)), alpha=.2, fill="lightgreen") +
  labs(y = "count", x = "CR", title ="Correct Rejection Rate (CR) distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 # dev.off()


# jpeg("DistributionD'S1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(dprime)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(1000 * 0.02)), alpha=.2, fill="lightgreen") +<
  
  labs(y = "count", x = "d'", title ="D prime distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) 
  # scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
  #                limits = c(-0.01,1.01))
 # dev.off()


```


#Outliers on d'
```{r}
perf_outliers <- Nback_blocks %>%
filter(dprime <= 0)
#2470 outliers (638 out of ~6500 1-back tasks (10%), 1832 out of ~7500 3-back tasks(25 %))

Nback_blocks <- Nback_blocks %>%
filter(dprime > 0)
```





```{r}

#HR DISTRIBUTION


# jpeg("DistributionHRS1pro2.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(HR)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(1000 * 0.02)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "HR", title ="Hit Rate (HR) distribution for 1-back and 3-back after d' outliers removal") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 # dev.off()

#FA DISTRIBUTION

# jpeg("DistributionFAS1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(FA)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(500 * 0.02)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "FA", title ="False alarm rate (FA) distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 # dev.off()

#CR DISTRIBUTION


# jpeg("DistributionCRS1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(CR)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") +
      # geom_density(aes(y = ..density..*(00 * 0.02)), alpha=.2, fill="lightgreen") +
  labs(y = "count", x = "CR", title ="Correct Rejection Rate (CR) distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                 limits = c(-0.01,1.01))
 # dev.off()





```






## N-BACK PERFORMANCE (Correct Response Rate, False Alarm Rate, mRT)


#N-back Performance table and N-Back Performance Graphs for different WM load and Task duration
```{r}
perfNback <- Nback_blocks %>%
  filter(!is.na(mRT)) %>%
  group_by(nback, duration) %>%
  summarise(HR = mean(HR),
            mRT = mean(mRT),
            FA = mean(FA))

semHR <- aggregate(HR ~ nback + duration, Nback_blocks, sem) 
semmRT <- aggregate(mRT ~ nback + duration, Nback_blocks, sem) #apply sem function 
semFA <- aggregate(FA ~ nback + duration, Nback_blocks, sem) 

perfNback <- bind_cols(perfNback, semHR$HR, semmRT$mRT, semFA$FA) %>% 
  rename(semHR = ...6, semmRT = ...7, semFA = ...8 )

paged_table(perfNback)

# Correct response rate VS WM load and task duration
perf_HR = perfNback %>% ggplot (aes(x = nback,
                                              y = HR,
                                              group = duration,
                                              colour = duration)) +
  geom_point(size = 2) +
  geom_line(aes(group = duration), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "Hit Rate") +
  theme( legend.text = element_text(size = 15),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin = HR - semHR, ymax = HR + semHR),
                colour = "black",
                width = .05) +
  scale_colour_manual(values = cbPalette2) +
  scale_y_continuous(breaks = seq(from = 0.30, to = 0.80, by = 0.10),
limits = c(0.29, 0.80))

# False Alarm rate VS WM load and task duration
perf_FA = perfNback %>% ggplot (aes(x = nback,
                                              y = FA,
                                              group = duration,
                                              colour = duration)) +
  geom_point(size = 2) +
  geom_line(aes(group = duration), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "False Alarm Rate") +
  theme( legend.text = element_text(size = 15),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin =FA - semFA, ymax = FA + semFA),
                colour = "black",
                width = .05) +
  scale_colour_manual(values = cbPalette2) +
  scale_y_continuous(breaks = seq(from = 0, to = 0.20, by = 0.05),
limits = c(0, 0.22)) 

# mean Reaction Time VS WM load and task duration
perf_mRT = perfNback %>% 
  ggplot (aes(x = nback, y = mRT,
              group = duration,
              colour = duration)) +
  geom_point(size = 2) +
  geom_line(aes(group = duration), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "Mean Reaction Time (ms)") +
  theme( legend.text = element_text(size = 11),
         legend.title = element_text(size = 11),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13),
   legend.position = c(.8, .2))  +
  geom_errorbar(aes(ymin =mRT - semmRT, ymax = mRT + semmRT),
                colour = "black",
                width = .05)  +
  scale_y_continuous(breaks = seq(from = 500, to = 600, by = 20),
limits = c(500, 600)) +
  scale_colour_manual(values = cbPalette2, labels = c("45s", "90s"))


#merge the 3 graphs and save the final graph
perf_HR <- perf_HR + theme(legend.position = "none")
perf_FA <- perf_FA + theme(legend.position = "none")
perf_mRT = perf_mRT 

title <- ggdraw() + draw_label(
    "Fig.1: N-back performance VS working memory load and task duration",
    fontface = 'bold', size = 13) +
  theme(plot.margin = margin(0, 5, 10 ,0))

plot_row = plot_grid(perf_HR, perf_FA, perf_mRT, nrow=1, labels=c('A', 'B', 'C'))
    
# jpeg("PerfNbackDurationproS1.jpg", width = 4000, height = 2500, units = "px",res=600)
  plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1))  # rel_heights values control vertical title margins
# dev.off()
```




#N-back Performance table and N-Back Performance Graphs for different WM load and ILI (Inter-letter interval)
```{r}

perfNback <- Nback_blocks %>%
  filter(!is.na(mRT)) %>%
  group_by(nback, ILI) %>%
  summarise(HR = mean(HR),
            mRT = mean(mRT),
            FA = mean(FA))

semHR <- aggregate(HR ~ nback + ILI, Nback_blocks, sem) 
semmRT <- aggregate(mRT ~ nback + ILI, Nback_blocks, sem)  #apply sem function 
semFA <- aggregate(FA ~ nback + ILI, Nback_blocks, sem) 

perfNback <- bind_cols(perfNback, semHR$HR, semmRT$mRT, semFA$FA) %>% 
  rename(semHR = ...6, semmRT = ...7, semFA = ...8 )

paged_table(perfNback)


perf_HR = perfNback %>% ggplot (aes(x = nback,
                                              y = HR,
                                              group = ILI,
                                              colour = ILI)) +
  geom_point(size = 2) +
  geom_line(aes(group = ILI), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "Hit Rate") +
  theme( legend.text = element_text(size = 15),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin = HR - semHR, ymax = HR + semHR),
                colour = "black",
                width = .05) +
  scale_colour_manual(values = cbPalette2_v2) +
  scale_y_continuous(breaks = seq(from = 0.40, to = 0.80, by = 0.10),
limits = c(0.4, 0.80))


perf_FA = perfNback %>% ggplot (aes(x = nback,
                                              y = FA,
                                              group = ILI,
                                              colour = ILI)) +
  geom_point(size = 2) +
  geom_line(aes(group = ILI), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "False Alarm Rate") +
  theme( legend.text = element_text(size = 15),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin =FA - semFA, ymax = FA + semFA),
                colour = "black",
                width = .05) +
  scale_colour_manual(values = cbPalette2_v2)  +
  scale_y_continuous(breaks = seq(from = 0, to = 0.15, by = 0.05),
limits = c(0.00, 0.18)) 


# mean Reaction Time VS WM load and ILI
perf_mRT = perfNback %>% 
  ggplot (aes(x = nback, y = mRT,
              group = ILI,
              colour = ILI)) +
  geom_point(size = 2) +
  geom_line(aes(group = ILI), size = 1) +
  theme_classic() +
  labs(x = "WM load", y = "Mean Reaction Time (ms)") +
  theme( legend.text = element_text(size = 11),
         legend.title = element_text(size = 11),
          axis.text = element_text(size = 12),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13),
   legend.position = c(.8, .2))  +
  geom_errorbar(aes(ymin =mRT - semmRT, ymax = mRT + semmRT),
                colour = "black",
                width = .05) +
  scale_y_continuous(breaks = seq(from = 520, to = 600, by = 20),
limits = c(510, 600)) +
  scale_colour_manual(values = cbPalette2_v2, labels = c("1500ms", "1800ms"))


#merge the 3 graphs and save the final graph
perf_HR <- perf_HR + theme(legend.position = "none")
perf_FA <- perf_FA + theme(legend.position = "none")
perf_mRT = perf_mRT 

title <- ggdraw() + draw_label(
    "Fig.1: N-back performance VS working memory load and ILI",
    fontface = 'bold', size = 13) +
  theme(plot.margin = margin(0, 5, 10 ,0))

plot_row = plot_grid(perf_HR, perf_FA, perf_mRT, nrow=1, labels=c('A', 'B', 'C'))
          
# jpeg("PerfNbackILIproS1.jpg", width = 4000, height = 2500, units = "px",res=600)
  plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1)) # rel_heights values control vertical title margins
# dev.off()
```

#Timing Error
```{r}

# jpeg("DistribTES1pro.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(timing_error)) + 
  facet_grid(.~duration) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=1,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(8000 * 1)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "Timing Error (s)", title ="Timing Error distribution for 45s/90s tasks (before outliers removal)") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) 
  # scale_x_continuous(breaks = seq(from = -90, to = 220, by = 30),
  # limits = c(-90, 230))
# dev.off()
```




#Outliers removal on Timing Error
```{r}
#Outliers on d'

Nback_blocks <- Nback_blocks %>%
  group_by(duration) %>%
  mutate(ZTiming = scale(timing_error))

estimation_outliers <- Nback_blocks %>%
filter(abs(ZTiming) > 2)    #358 outliers  (155 for 45s)
  
Nback_blocks %>%
  ggplot() + geom_histogram(mapping = aes(ZTiming))

Nback_blocks <-  Nback_blocks %>%        #11569 -> 11211 trials
  filter(abs(ZTiming) <= 2 )
```

#Timing Error
```{r}

# jpeg("DistribTE2S1pro.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(timing_error)) + 
  facet_grid(.~duration) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=1,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(5000 * 1)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "Timing Error (s)", title ="Timing Error distribution for 45s/90s tasks (after outliers removal)") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = -90, to = 90, by = 15),
  limits = c(-100, 100))
# dev.off()
```














##Subjective vs Objective Duration (with and without ILI)
```{r}
#Duration estimation tables 

durations <- Nback_blocks %>%
  group_by(nback) %>% 
  group_by(duration, .add = T) %>% 
  summarize(DD = mean(timing_error), semDD = sem(timing_error))

durations_by_ILI <- Nback_blocks%>%
  group_by(duration, .add = T) %>%   
  group_by(ILI, .add = T) %>%
  group_by(nback, .add = T) %>%
  summarize(DD = mean(timing_error), semDD = sem(timing_error))



#Subjective vs Objective Duration graph
DD_vs_OD_Nback = durations %>% ggplot (aes(x = duration,
                                              y = DD,
                                              group = nback,
                                              colour = nback)) +
scale_y_continuous(breaks = seq(from = -20, to = 0, by = 5),
                     limits = c(-23, 5)) +
  geom_hline(aes(yintercept = 0), 
             colour = 'black', 
             size = .5, 
             linetype = "dashed") +
  geom_point(size = 2) +
  geom_line(aes(group = nback), size = 1) +
  theme_classic() +
  labs(y = "Subjective timing Error (s)", x = "Objective Task Duration") +
  theme(legend.text = element_text(size = 11),
         legend.title  = element_text(size = 12),
        axis.title.x = element_text(size = 12),
         axis.title.y = element_text(size = 12),
          axis.text = element_text(size = 12),
  legend.position = c(.90, .65),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin = DD - semDD, ymax = DD + semDD),
                colour = "black",
                width = .05) +
  scale_colour_manual(values = cbPalette, labels = c("1-back", "3-back"), name = "WM load")

#Subjective vs Objective Duration with ILI
DD_vs_OD_ILI = durations_by_ILI %>%
  ggplot (aes(x = duration,
                 y = DD,
                group = ILI,
                colour = ILI)) +
  scale_y_continuous(breaks = seq(from = -20, to = 0, by = 5),
                     limits = c(-23, 5)) +
  geom_hline(aes(yintercept = 0), 
             colour = 'black', 
             size = .5, 
             linetype = "dashed") +
  geom_point(size = 2) +
  geom_line(aes(group = ILI), size = 1) +
  theme_classic() +
  labs(y = "Subjective Timing Error (s)", x = "Objective Task Duration") +
  theme( legend.text = element_text(size = 11),
         legend.title  = element_text(size = 12),
         axis.title.x = element_text(size = 12),
         axis.title.y = element_text(size = 12),
          axis.text = element_text(size = 12),
  legend.position = c(.90, .65),
  plot.title = element_text(face = "bold", "hjust" = 0.5), axis.title= element_text(size = 13)) +
  geom_errorbar(aes(ymin = DD - semDD, ymax = DD + semDD),
                colour = "black",
                width = .05) +
 scale_colour_manual(values = cbPalette2_v2, labels = c("1500ms", "1800ms")) +
  facet_grid(.~nback)


#Merge the two graphs
title <- ggdraw() + draw_label(
    "Subjective Timing Error VS Objective Duration for different conditions",
    fontface = 'bold', size = 13) +
  theme(plot.margin = margin(0, 5, 10 ,0))

plot_row = plot_grid(DD_vs_OD_Nback + theme(plot.margin = margin(0, 30, 0, 0)),
  DD_vs_OD_ILI + theme(plot.margin = margin(0, 10, 0, 0)),  
  nrow=1, labels=c('A', 'B'),  rel_widths =  c(3, 5))
          
# jpeg("SD_ODproS1.jpg", width = 5000, height = 2500, units = "px",res=600)
  plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1))
# dev.off()


```








##Timing Error Violin Plot
```{r}

Violin_1TE <- Nback_blocks %>% 
  filter(duration == "45s") %>%
  ggplot(aes(nback, timing_error, colour = nback)) +
  geom_hline(aes(yintercept = 0), 
             colour = 'black', 
             size = .5, 
             linetype = "dashed") +
  geom_violin() +
  geom_boxplot(width=0.2, color="black", alpha=0.6, outlier.shape=NA) +
stat_summary(fun = mean)  +
  theme_classic() +
  labs(y = "Timing Error (s)", x = "WM load", title = "45s (N = 5483)") +
  theme( legend.position="none",
        axis.title.x = element_text(size = 12),
         axis.title.y = element_text(size = 12),
        axis.text = element_text(size = 12),
  plot.title = element_text("hjust" = 0.5), axis.title= element_text(size = 13)) + scale_y_continuous(breaks = seq(from = -90, to = 90, by = 15),
                     limits = c(-90, 100)) +
  scale_colour_manual(values = cbPalette2) +
 stat_compare_means(method = "wilcox.test", paired = FALSE, label = "p.format", comparisons = list(c("1back","3back")))


Violin_3TE <- Nback_blocks %>% 
  filter(duration == "90s") %>%
  ggplot(aes(nback, timing_error, colour = nback)) +
  geom_hline(aes(yintercept = 0), 
             colour = 'black', 
             size = .5, 
             linetype = "dashed") +
  geom_violin() +
  geom_boxplot(width=0.2, color="black", alpha=0.6, outlier.shape=NA) +
  stat_summary(fun = mean)  +
  theme_classic() +
  labs(y = "Timing Error (s)", x = "WM load", title = "90s (N = 5738)") +
  theme( legend.position="none",
        axis.title.x = element_text(size = 12),
         axis.title.y = element_text(size = 12),
          axis.text = element_text(size = 12),
  plot.title = element_text("hjust" = 0.5), axis.title= element_text(size = 13)) + scale_y_continuous(breaks = seq(from = -90, to = 90, by = 15),
                     limits = c(-90, 120)) +
  scale_colour_manual(values = cbPalette2) +
 stat_compare_means( method = "wilcox.test", paired = FALSE, label = "p.format", comparisons = list(c("1back","3back")))


#Merge the two graphs
title <- ggdraw() + draw_label(
    "Timing Error distribution vs Task Duration for 1-back and 3-back",
    fontface = 'bold', size = 13) +
  theme(plot.margin = margin(0, 5, 10 ,0))

plot_row = plot_grid(Violin_1TE + theme(plot.margin = margin(0, 30, 0, 0)),
  Violin_3TE + theme(plot.margin = margin(0, 10, 0, 0)),  
  nrow=1)
          
# jpeg("ViolinTEretro.jpg", width = 5000, height = 2500, units = "px",res=600)
  plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1))
# dev.off()



```




##Timing Error Violin Plot
```{r}

Violin_TEduration <- Nback_blocks %>% 
  ggplot(aes(duration, timing_error, colour = duration)) +
  geom_hline(aes(yintercept = 0), 
             colour = 'black', 
             size = .5, 
             linetype = "dashed") +
  geom_violin() +
  geom_boxplot(width=0.2, color="black", alpha=0.6, outlier.shape=NA) +
stat_summary(fun = mean)  +
  theme_classic() +
  labs(y = "Timing Error (s)", x = "WM load", title = "Timing Error distribution for 45 an 90s task duration") +
  theme( legend.position="none",
        axis.title.x = element_text(size = 12),
         axis.title.y = element_text(size = 12),
        axis.text = element_text(size = 12),
  plot.title = element_text("hjust" = 0.5), axis.title= element_text(size = 13)) + scale_y_continuous(breaks = seq(from = -90, to = 90, by = 15),
                     limits = c(-90, 110)) +
  scale_colour_manual(values = cbPalette2) +
 stat_compare_means(method = "wilcox.test", paired = FALSE, label = "p.format", comparisons = list(c("45s","90s")))


Violin_TEduration

sd(Nback_blocks$timing_error)


Nback_blocks %>% 
  group_by(nback) %>%
  group_by(duration, .add =T) %>%
  summarise(VarSD = var(as.numeric(as.character(translated))), 
            semSD = sd(as.numeric(as.character(translated))/sqrt(n())))
```













# Mixed-effect models Timing Error
```{r}
data <- Nback_blocks  #11221

M1 <-lmer(timing_error ~ duration + (1|PID), data=data, REML=FALSE)

M2 <-lmer(timing_error ~ duration + nback + (1|PID), data=data, REML=FALSE)
lrtest(M1, M2) #M1 nested #M2 more complex   p <0.05  #the complex model is significantly more accurate

M3 <-lmer(timing_error ~ duration + nback + ILI + (1|PID), data=data, REML=FALSE)
lrtest(M2, M3) #M2 nested #M3 more complex  p > 0.05  #the complex model is not significantly more accurate

M4 <-lmer(timing_error ~ duration * nback * ILI + (1|PID), data=data, REML=FALSE)
lrtest(M2, M4)   #M2 nested #M4 more complex      p <0.05  #the complex model is significantly more accurate

M5 <-lmer(timing_error ~ duration + nback + ILI + (duration|PID), data=data, REML=FALSE)
lrtest(M3, M5)  #M3 nested #5 more complex    p <0.05  #the complex model is significantly more accurate

M6 <-lmer(timing_error ~ duration + nback + ILI + (duration + nback|PID), data=data, REML=FALSE)
lrtest(M5, M6)   #M5 nested #6 more complex   p <0.05  #the complex model is significantly more accurate

M7 <-lmer(timing_error ~ duration + nback + ILI + (duration + nback + ILI|PID), data=data, REML=FALSE)
lrtest(M6, M7) # n.s

M8 <-lmer(timing_error ~ duration * nback + (duration + nback|PID), data=data, REML=FALSE)
lrtest(M6, M8) #M7 nested #8 more complex   p <0.05  #the complex model is significantly more accurate

M9 <-lmer(timing_error ~ duration * nback * ILI + (duration + nback|PID), data=data, REML=FALSE)
lrtest(M8, M9)   #M8 nested #9 more complex   p = 0.08  


 
# summary(M1)
# summary(M2)
# summary(M3)
# summary(M4)
# summary(M5)
summary(M6)
summary(M7)
summary(M8)
summary(M9)


r2(M8)
compare_performance(M6, M7, M8, M9)
#we use M8

```

#Main effects
```{r}
M8 <-lmer(timing_error ~ duration * nback + (duration + nback|PID), data=data, REML=T)
summary(M8)

stargazer(M8, type = "text",
           title = "Regression results M2",
          header = FALSE,
          single.row = TRUE,
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")

anova(M8)

emm_options(lmer.df ="satterthwaite")

emm_options(lmer.df = "satterthwaite")
get_emm_option("lmer.df")


emmeans(M8, ~duration)

# -- Main effect of duration --   => Significant effect
emmeans(M8, ~ duration) 

# -- Main effect of WM Load --    => Significant effect
emmeans(M8, ~ nback,  lmer.df = "satterthwaite") 

# -- Main effect of Interaction duration / nback 

emmeans(M8, pairwise ~ duration | nback,  lmer.df = "satterthwaite")

emmeans(M8, pairwise ~ nback | duration,  lmer.df = "satterthwaite")   #significant when 90s 1800ms

# interaction.emm <- emmeans(M9, pairwise ~ ILI | duration + nback)  # significant when 90s 3-back
# interaction.emm

```

# Verification of model assumptions ####
```{r}

R1 <- resid(M8)
F1 <- fitted(M8)

## residuals distribution : histogramme and shapiro test for normality
hist(R1, breaks = 30)

# shapiro.test(R1)

## homogeneity : fitted values vs normalized residuals

plot(x = F1, 
     y = R1, 
     xlab = "Fitted Values",
     ylab = "Normalized residuals")
abline(h = 0, lty = 2)

#timing_error
plot(x = data$timing_error, 
     y = R1, 
     xlab = "timing_error",
     ylab = "Normalized residuals")
abline(h = 0, lty = 2)


## independance : residuals vs each model covariable

# duration
boxplot(R1 ~ duration,   
        ylab = "Normalized residuals",
        data = data, xlab = "task duration")
abline(h = 0, lty = 2)

# nback
boxplot(R1 ~ nback,   
        ylab = "Normalized residuals",
        data = data, xlab = "nback")
abline(h = 0, lty = 2)



# data %>%
#  ggplot(aes(timing_error, R1, colour = dprime)) + 
#            geom_point() +
#       # geom_density(aes(y = ..density..*(500 * 0.02)), alpha=.4, fill="lightgreen") +
#   labs(y = "residuals", x = "timing_error", title ="model for 1-back retrospective tasks, residuals vs TE") + 
#   theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) 
#   # scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
#   #                limits = c(-0.01,1.01))


```










#Main effects
```{r}
data <- data %>%
  mutate(relative_error = (as.numeric(as.character(translated)) - parse_number(as.character(duration))) / parse_number(as.character(duration)))
  



M6 <-lmer(relative_error ~ duration + nback + ILI + (duration + nback|PID), data=data, REML=T)
summary(M6)


data <- data %>%
  mutate(cdur = ifelse(cdur == 3, 9, cdur),
         cdur = ifelse(cdur == 4, 10, cdur))
  
M9 <-lmer(timing_error ~ duration  + cdur + (cdur|PID), data=data, REML= T)

stargazer(M9, type = "text",
           title = "Regression results M2",
          header = FALSE,
          single.row = TRUE,
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")

summary(M9)
anova(M9)



# -- Main effect of duration --   => Significant effect
duration.emm <- emmeans(M9, ~ duration) 
duration.emm
plot(duration.emm, by = NULL, comparisons = TRUE, adjust = "mvt",
     horizontal = FALSE, colors = "darkgreen")
# pwpp(duration.emm)


# -- Main effect of WM Load --    => No significant effect
nback.emm <- emmeans(M9, ~ nback) 
nback.emm
plot(nback.emm, by = NULL, comparisons = TRUE, adjust = "mvt",
     horizontal = FALSE, colors = "darkgreen")
# pwpp(nback.emm)

# # -- Main effect of ILI --        => No significant effect
# ILI.emm <- emmeans(M6, ~ ILI) 
# ILI.emm
# plot(ILI.emm, by = NULL, comparisons = TRUE, adjust = "mvt",
#      horizontal = FALSE, colors = "darkgreen")
# # pwpp(ILI.emm)



# -- Main effect of Interaction duration / nback / ILI

interaction.emm <- emmeans(M9, pairwise ~ duration | nback, pbkrtest.limit = 11221)
interaction.emm
interaction.emm <- emmeans(M9, pairwise ~ nback | duration , pbkrtest.limit = 11221)   #significant when 90s 1800ms
interaction.emm
# interaction.emm <- emmeans(M9, pairwise ~ ILI | duration + nback)  # significant when 90s 3-back
# interaction.emm


```

# Verification of model assumptions ####
```{r}

M8 <-lmer(timing_error ~ duration * nback * ILI + (duration + nback|PID), data=data, REML=FALSE)
M8bis <-lmer(timing_error ~ duration * nback * ILI + estim + (duration + nback|PID), data=data, REML=FALSE)

R1 <- resid(M6)
F1 <- fitted(M6)

## residuals distribution : histogramme and shapiro test for normality
hist(R1, breaks = 30)

# shapiro.test(R1)

## homogeneity : fitted values vs normalized residuals

plot(x = F1, 
     y = R1, 
     xlab = "Fitted Values",
     ylab = "Normalized residuals")
abline(h = 0, lty = 2)

# duration_deviation
plot(x = data$timing_error, 
     y = R1, 
     xlab = "timing_error",
     ylab = "Normalized residuals")
abline(h = 0, lty = 2)

# Participants
boxplot(R1 ~ PID,   
        ylab = "Normalized residuals",
        data = data, xlab = "Participant")
abline(h = 0, lty = 2)


## independance : residuals vs each model covariable



# duration
boxplot(R1 ~ duration,   
        ylab = "Normalized residuals",
        data = data, xlab = "task duration")
abline(h = 0, lty = 2)

# nback
boxplot(R1 ~ nback,   
        ylab = "Normalized residuals",
        data = data, xlab = "nback")
abline(h = 0, lty = 2)
 
#ILI
boxplot(R1 ~ ILI,   
        ylab = "Normalized residuals",
        data = data, xlab = "ILI")
abline(h = 0, lty = 2)

```






#Passing of time statistic models
```{r}

data = Nback_blocks %>%
  filter(nback == "1back")

library(MASS)

m1 = polr(likert_n ~ duration, data, Hess=T)

m2 = clmm(likert_n ~ duration + nback + (1|PID), data, Hess=T, nAGQ= 7)
lrtest(m1,m2)  # p > 0.05

m3 = clmm(likert_n ~ duration * nback + (1|PID), data, Hess=T, nAGQ= 7)
lrtest(m1,m3)  # p < 0.05

m3 = clmm(likert_n ~ duration + ILI + (1|PID), data, Hess=T, nAGQ= 7)
lrtest(m1,m3) 

m4 = clmm(likert_n ~ duration + nback + ILI + (1|PID), data, Hess=T, nAGQ= 7)
lrtest(m2,m4)  # p < 0.05

m5 = clmm(likert_n ~ duration * nback * ILI + (1|PID), data, Hess=T, nAGQ= 7)
lrtest(m4,m5)  # p < 0.05

AIC<-c(AIC(m1), AIC(m2), AIC(m3), AIC(m4), AIC(m5))
model<-c("m1", "m2", "m3", "m4", "m5")
AICtable<-data.frame(Model=model, AIC=AIC)
AICtable


summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)



#we choose m6
```

#Main effects
```{r}

# ----- Pairwise comparisons ----------------------

# -- Main effect of duration --

duration.emm <- emmeans(m5, ~ duration) 
duration.emm
plot(duration.emm, by = NULL, comparisons = TRUE, adjust = "mvt", 
     horizontal = FALSE, colors = "darkgreen")
pwpp(duration.emm)

# -- Main effect of nback --

nback.emm <- emmeans(m5, ~ nback) 
nback.emm
plot(nback.emm, by = NULL, comparisons = TRUE, adjust = "mvt", 
     horizontal = FALSE, colors = "darkgreen")
pwpp(nback.emm)


# -- Main effect of session --

ILI.emm <- emmeans(m5, ~ ILI) 
ILI.emm
plot(ILI.emm, by = NULL, comparisons = TRUE, adjust = "mvt", 
     horizontal = FALSE, colors = "darkgreen")
pwpp(ILI.emm)

# -- Main effect of Interaction nback / session / duration

interaction1.emm <- emmeans(m5, pairwise ~ nback | ILI + duration)
interaction1.emm

interaction2.emm <- emmeans(m5, pairwise ~ ILI |nback + duration)
interaction2.emm

interaction3.emm <- emmeans(m5, pairwise ~ duration |nback + ILI)
interaction3.emm





# chisq.test(NbackL_blocks$perf, NbackL_blocks$likert)
# chisq.test(NbackL_blocks$mRT, NbackL_blocks$likert)   #no correlation between mRT and likert
# chisq.test(NbackL_blocks$MR, NbackL_blocks$likert)
# chisq.test(NbackL_blocks$FAR, NbackL_blocks$likert)
# chisq.test(NbackL_blocks$CRR, NbackL_blocks$likert)



```






























# mean Reaction Time distribution for 1-back and 3-back 
```{r}
 mRT_1back <-  Nback_blocks %>%
  filter(nback == "1back") 
 mRT_3back <- Nback_blocks %>%
  filter(nback == "3back") 
 

# QQ plot
 title <- ggdraw() + 
   draw_label("Normal QQ plot of mean Reaction Time for 1-back and 3-back",
    fontface = 'bold', size = 13) +
  theme(plot.margin = margin(0, 0, 15 ,0))

plot_row = plot_grid(ggqqplot(mRT_1back$mRT, size = 0.2),
                     ggqqplot(mRT_3back$mRT, size = 0.2), 
                     nrow=1, labels=c('1-back', '3-back'),
  label_size = 11,
  hjust = -0.5, vjust = -0.5)
          
# jpeg("QQplotmRTS1.jpg", width = 4000, height = 2500, units = "px",res=600)
  plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1))
# dev.off()

#shapiro-wilk test  H0 = normal
shapiro.test(mRT_1back$mRT)
shapiro.test(mRT_3back$mRT)


#the two distribution are skewed ! 


# jpeg("DistributionmRTS1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(mRT)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth= 30,
                   colour = "black" , fill="white") + 
      geom_density(aes(y = ..density..*(1800 * 30)), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "Hit Rate", title ="Mean Reaction Time Distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) +
  scale_x_continuous(breaks = seq(from = 0, to = 1300, by = 250),
                 limits = c(0,1300))
 # dev.off()



skewness(filter(
  Nback_blocks, nback == "1back")$mRT, na.rm = TRUE)   #positive asymetrie

skewness(filter(
  Nback_blocks, nback == "3back")$mRT, na.rm = TRUE)   #positive asymetrie


Nback_blocks$normRT <- log10(Nback_blocks$mRT)
mRT_1back$normRT <- log10(mRT_1back$mRT)
mRT_3back$normRT <- log10(mRT_3back$mRT)


skewness(filter(
  Nback_blocks, nback == "1back")$normRT, na.rm = TRUE)   #positive asymetrie

skewness(filter(
  Nback_blocks, nback == "3back")$normRT, na.rm = TRUE)   #negative asymetrie
#sqrt(x) pour les données asymétriques positives ?

# jpeg("DistributionmRTS1.jpg", width = 4000, height = 2500, units = "px",res=600)
Nback_blocks %>%
  ggplot(aes(normRT)) + 
  facet_grid(.~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth= 0.01,
                   colour = "black" , fill="white") + 
      geom_density(aes(y = ..density..), alpha=.4, fill="lightgreen") +
  labs(y = "count", x = "Hit Rate", title ="Mean Reaction Time Distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) 
  # scale_x_continuous(breaks = seq(from = 0, to = 1300, by = 250),
  #                limits = c(0,1300))
 # dev.off()

shapiro.test(mRT_1back$normRT)
shapiro.test(mRT_3back$normRT)
```


#Outliers on d' "old fashion way
```{r}
dprime <- Nback_blocks %>%
  group_by(country) %>%
  group_by(PID, .add = T) %>%
  group_by(nback, .add = T) %>%
  summarise( HR = sum(hit)/sum(ntarget),
            FA = sum(fa)/sum(notarget)) %>%
  mutate( HR = ifelse(HR == 1, 0.99, HR),
          HR = ifelse(HR == 0, 0.01, HR),
  FA = ifelse(FA == 0, 0.01, FA),
  FA = ifelse(FA == 1, 0.99, FA)) %>%
  mutate(dprimeb = qnorm(HR) - qnorm(FA)) %>%
  select(country, nback, PID, dprimeb)

jpeg("DistributionD'S1pro.jpg", width = 4000, height = 2500, units = "px",res=600)
dprime %>%
  ggplot(aes(dprimeb)) +
  facet_grid(~nback) +
           geom_histogram(aes(y = ..count..), position = "dodge", binwidth=0.02,
                   colour = "black" , fill="white") + 
      # geom_density(aes(y = ..density..*(1000 * 0.02)), alpha=.2, fill="lightgreen") +
  labs(y = "count", x = "d'", title ="D prime distribution for 1-back and 3-back") + 
  theme(plot.title = element_text(face = "bold", "hjust" = 0.5)) 
  # scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
  #                limits = c(-0.01,1.01))
 dev.off()



perf_outliers <- dprime %>%
filter(dprimeb <= 0)
#150 outliers, 53 1back, 97 3-back

dprime <- dprime %>%
  mutate(outliers = ifelse(dprimeb > 0, "no", "yes"))

Nback_blocks <- left_join(Nback_blocks, dprime, by = c("country", "PID", "nback"))

Nback_blocks <- Nback_blocks %>%
  filter(outliers == "no") 
#14052 --> 13299
#745 outliers  (~5%)    246 1-back
```
